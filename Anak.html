<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kuesioner Skrining TBC Anak</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      /* Custom style untuk radio dan checkbox */
      input[type="radio"]:checked + span::before {
        background-color: #3b82f6;
        border-color: #3b82f6;
      }
      input[type="radio"]:checked + span::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 0.5rem;
        height: 0.5rem;
        background-color: white;
        border-radius: 50%;
      }
      input[type="checkbox"]:checked + span::before {
        background-color: #3b82f6;
        border-color: #3b82f6;
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='m12.207 4.793a1 1 0 0 0-1.414 0L6.5 9.086 4.707 7.293a1 1 0 0 0-1.414 1.414l2.5 2.5a1 1 0 0 0 1.414 0l5.5-5.5a1 1 0 0 0 0-1.414z'/%3e%3c/svg%3e");
        background-position: center;
        background-repeat: no-repeat;
      }

      /* Animasi untuk modal */
      .modal-transition {
        transition: all 0.3s ease;
      }

      /* Animasi untuk tombol */
      .btn-hover {
        transition: all 0.2s ease;
      }

      /* Animasi untuk loading spinner */
      .spinner {
        border: 3px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top: 3px solid white;
        width: 20px;
        height: 20px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      /* Tooltip style */
      .tooltip {
        position: relative;
      }

      .tooltip .tooltiptext {
        visibility: hidden;
        width: 200px;
        background-color: #333;
        color: #fff;
        text-align: center;
        border-radius: 6px;
        padding: 5px;
        position: absolute;
        z-index: 1;
        bottom: 125%;
        left: 50%;
        margin-left: -100px;
        opacity: 0;
        transition: opacity 0.3s;
        font-size: 12px;
      }

      .tooltip:hover .tooltiptext {
        visibility: visible;
        opacity: 1;
      }

      /* Validasi error style */
      .error-input {
        border-color: #ef4444 !important;
        box-shadow: 0 0 0 1px #ef4444 !important;
      }

      /* Success notification */
      .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: bold;
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.3s ease;
      }

      .notification.show {
        transform: translateX(0);
      }

      .notification.success {
        background-color: #10b981;
      }

      .notification.error {
        background-color: #ef4444;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-blue-50 to-indigo-100 font-sans min-h-screen flex items-center justify-center p-4"
  >
    <!-- Notification Container -->
    <div id="notification" class="notification"></div>

    <div
      class="w-full max-w-2xl bg-white rounded-3xl shadow-2xl overflow-hidden"
    >
      <!-- Header -->
      <header class="bg-gradient-to-r from-blue-500 to-indigo-600 p-8">
        <div
          class="flex flex-col sm:flex-row items-center justify-center gap-4"
        >
          <img
            src="https://pkmtrenggalek.github.io/SIPP/Assets/pkmtglk.jpeg"
            alt="Logo PKM Trenggalek"
            class="h-16 w-auto bg-white p-1 rounded-lg shadow-md"
          />
          <div class="text-center sm:text-left">
            <h1 class="text-3xl font-bold text-white">
              LEMBAR SKRINING TBC ANAK
            </h1>
            <p class="text-blue-100 mt-2">Posyandu & Puskesmas</p>
          </div>
        </div>
      </header>

      <!-- Form Container -->
      <div class="p-8 space-y-8">
        <form id="tbcForm" class="space-y-8" novalidate>
          <!-- Data Diri Anak -->
          <section class="bg-blue-50 rounded-xl p-5 border border-blue-200">
            <h2 class="text-xl font-bold text-blue-800 mb-5">
              Data Diri Pasien
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label
                  for="nama"
                  class="block text-sm font-medium text-gray-700"
                  >Nama Lengkap <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="nama"
                  name="nama"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                />
                <p class="text-red-500 text-xs mt-1 hidden" id="nama-error">
                  Nama harus diisi
                </p>
              </div>
              <div>
                <label for="nik" class="block text-sm font-medium text-gray-700"
                  >NIK <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="nik"
                  name="nik"
                  required
                  maxlength="16"
                  pattern="[0-9]{16}"
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                />
                <p class="text-red-500 text-xs mt-1 hidden" id="nik-error">
                  NIK harus diisi (16 digit angka)
                </p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700">
                  Jenis Kelamin <span class="text-red-500">*</span>
                </label>
                <div class="mt-2 flex space-x-4">
                  <label class="flex items-center cursor-pointer">
                    <input
                      type="radio"
                      name="jenis_kelamin"
                      value="Laki-laki"
                      required
                      class="peer sr-only"
                    />
                    <span
                      class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-blue-500 transition"
                    ></span>
                    <span class="ml-2 text-sm text-gray-700">Laki-laki</span>
                  </label>
                  <label class="flex items-center cursor-pointer">
                    <input
                      type="radio"
                      name="jenis_kelamin"
                      value="Perempuan"
                      required
                      class="peer sr-only"
                    />
                    <span
                      class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-blue-500 transition"
                    ></span>
                    <span class="ml-2 text-sm text-gray-700">Perempuan</span>
                  </label>
                </div>
                <p class="text-red-500 text-xs mt-1 hidden" id="jk-error">
                  Jenis kelamin harus dipilih
                </p>
              </div>
              <div>
                <label
                  for="tanggal_lahir"
                  class="block text-sm font-medium text-gray-700"
                  >Tanggal Lahir <span class="text-red-500">*</span></label
                >
                <input
                  type="date"
                  id="tanggal_lahir"
                  name="tanggal_lahir"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                />
                <p class="text-red-500 text-xs mt-1 hidden" id="ttl-error">
                  Tanggal lahir harus diisi
                </p>
              </div>
              <div>
                <label
                  for="nama_orangtua"
                  class="block text-sm font-medium text-gray-700"
                  >Nama Orangtua <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="nama_orangtua"
                  name="nama_orangtua"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                />
                <p
                  class="text-red-500 text-xs mt-1 hidden"
                  id="nama_orangtua-error"
                >
                  Nama orangtua harus diisi
                </p>
              </div>
              <div>
                <label
                  for="nomor_telepon"
                  class="block text-sm font-medium text-gray-700"
                  >Nomor Telepon <span class="text-red-500">*</span></label
                >
                <input
                  type="tel"
                  id="nomor_telepon"
                  name="nomor_telepon"
                  required
                  pattern="[0-9]{10,13}"
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                />
                <p
                  class="text-red-500 text-xs mt-1 hidden"
                  id="nomor_telepon-error"
                >
                  Nomor telepon harus diisi (10-13 digit angka)
                </p>
              </div>
              <div class="md:col-span-2">
                <label
                  for="alamat"
                  class="block text-sm font-medium text-gray-700"
                  >Alamat <span class="text-red-500">*</span></label
                >
                <textarea
                  id="alamat"
                  name="alamat"
                  required
                  rows="2"
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                ></textarea>
                <p class="text-red-500 text-xs mt-1 hidden" id="alamat-error">
                  Alamat harus diisi
                </p>
              </div>
              <div>
                <label
                  for="posyandu"
                  class="block text-sm font-medium text-gray-700"
                  >Posyandu <span class="text-red-500">*</span></label
                >
                <input
                  type="text"
                  id="posyandu"
                  name="posyandu"
                  required
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
                />
                <p class="text-red-500 text-xs mt-1 hidden" id="posyandu-error">
                  Posyandu harus diisi
                </p>
              </div>
              <div class="md:col-span-2">
                <label
                  for="tanggal_skrining"
                  class="block text-sm font-medium text-gray-700 hidden"
                  >Tanggal Skrining</label
                >
                <input
                  type="date"
                  id="tanggal_skrining"
                  name="tanggal_skrining"
                  class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm hidden"
                  readonly
                />
              </div>
            </div>
          </section>

          <!-- Kuesioner Anak -->
          <section class="space-y-6">
            <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">
                A. Apakah tinggal serumah dengan pasien TBC?
                <span class="tooltip ml-2">
                  <i class="fas fa-info-circle text-blue-500 text-sm"></i>
                  <span class="tooltiptext"
                    >Pilih Ya jika anak tinggal dalam rumah yang sama dengan
                    penderita TBC</span
                  >
                </span>
              </h3>
              <div class="space-y-3">
                <label
                  class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
                >
                  <input
                    type="radio"
                    name="q_a"
                    value="ya"
                    required
                    class="peer sr-only"
                  />
                  <span
                    class="relative w-5 h-5 border-2 border-gray-400 rounded-full peer-checked:border-blue-500 transition"
                  ></span>
                  <span class="font-medium text-gray-700">Ya</span>
                </label>
                <label
                  class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
                >
                  <input
                    type="radio"
                    name="q_a"
                    value="tidak"
                    required
                    class="peer sr-only"
                  />
                  <span
                    class="relative w-5 h-5 border-2 border-gray-400 rounded-full peer-checked:border-blue-500 transition"
                  ></span>
                  <span class="font-medium text-gray-700">Tidak</span>
                </label>
              </div>
              <p class="text-red-500 text-xs mt-1 hidden" id="q_a-error">
                Pilihan harus dipilih
              </p>
            </div>
            <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">
                B. Apakah kontak erat dengan pasien TBC?
                <span class="tooltip ml-2">
                  <i class="fas fa-info-circle text-blue-500 text-sm"></i>
                  <span class="tooltiptext"
                    >Pilih Ya jika anak sering berinteraksi dekat dengan
                    penderita TBC</span
                  >
                </span>
              </h3>
              <div class="space-y-3">
                <label
                  class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
                >
                  <input
                    type="radio"
                    name="q_b"
                    value="ya"
                    required
                    class="peer sr-only"
                  />
                  <span
                    class="relative w-5 h-5 border-2 border-gray-400 rounded-full peer-checked:border-blue-500 transition"
                  ></span>
                  <span class="font-medium text-gray-700">Ya</span>
                </label>
                <label
                  class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
                >
                  <input
                    type="radio"
                    name="q_b"
                    value="tidak"
                    required
                    class="peer sr-only"
                  />
                  <span
                    class="relative w-5 h-5 border-2 border-gray-400 rounded-full peer-checked:border-blue-500 transition"
                  ></span>
                  <span class="font-medium text-gray-700">Tidak</span>
                </label>
              </div>
              <p class="text-red-500 text-xs mt-1 hidden" id="q_b-error">
                Pilihan harus dipilih
              </p>
            </div>
            <div class="bg-gray-50 rounded-xl p-5 border border-gray-200">
              <h3 class="text-lg font-semibold text-gray-800 mb-4">
                C. Apakah memiliki gejala-gejala TBC berikut?
                <span class="tooltip ml-2">
                  <i class="fas fa-info-circle text-blue-500 text-sm"></i>
                  <span class="tooltiptext"
                    >Pilih semua gejala yang dialami anak</span
                  >
                </span>
              </h3>
              <div class="space-y-3">
                <label
                  class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
                >
                  <input
                    type="checkbox"
                    name="gejala"
                    value="batuk"
                    class="peer sr-only"
                  />
                  <span
                    class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-blue-500 peer-checked:bg-blue-500 transition"
                  ></span>
                  <span class="text-gray-700">Batuk lebih dari 2 minggu</span>
                </label>
                <label
                  class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
                >
                  <input
                    type="checkbox"
                    name="gejala"
                    value="demam"
                    class="peer sr-only"
                  />
                  <span
                    class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-blue-500 peer-checked:bg-blue-500 transition"
                  ></span>
                  <span class="text-gray-700">Demam lebih dari 2 minggu</span>
                </label>
                <label
                  class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
                >
                  <input
                    type="checkbox"
                    name="gejala"
                    value="bb_turun"
                    class="peer sr-only"
                  />
                  <span
                    class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-blue-500 peer-checked:bg-blue-500 transition"
                  ></span>
                  <span class="text-gray-700"
                    >Berat badan tidak naik atau turun dalam 2 bulan
                    berturut-turut <br />
                    meskipun sudah diberikan asupan gizi yang adekuat</span
                  >
                </label>
                <label
                  class="flex items-center space-x-3 cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
                >
                  <input
                    type="checkbox"
                    name="gejala"
                    value="gizi_buruk"
                    class="peer sr-only"
                  />
                  <span
                    class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-blue-500 peer-checked:bg-blue-500 transition"
                  ></span>
                  <span class="text-gray-700">Gizi buruk</span>
                </label>
              </div>
            </div>
          </section>
        </form>
      </div>

      <!-- Tombol Submit -->
      <div class="px-8 pb-8">
        <button
          id="submitBtn"
          class="w-full bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-opacity-75 transition-all duration-300 transform hover:scale-105 btn-hover flex items-center justify-center"
        >
          <span id="btnText">Lihat Hasil Skrining</span>
          <div id="btnSpinner" class="spinner ml-2 hidden"></div>
        </button>
      </div>
    </div>

    <!-- Popup Modal Hasil -->
    <div
      id="resultModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 transition-opacity"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 relative modal-transition"
        id="modalContent"
      >
        <button
          id="closeModalBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>
        <div class="text-center">
          <div
            class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-800 mb-2">
            Hasil Skrining TBC
          </h2>
          <div class="mt-6 text-left bg-gray-50 rounded-lg p-4">
            <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 text-sm">
              <p class="font-semibold text-gray-600">Nama:</p>
              <p id="modalNama" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">NIK:</p>
              <p id="modalNIK" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Jenis Kelamin:</p>
              <p id="modalJk" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Tanggal Lahir:</p>
              <p id="modalTtl" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Nama Orangtua:</p>
              <p id="modalOrangtua" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Nomor Telepon:</p>
              <p id="modalTelepon" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Alamat:</p>
              <p id="modalAlamat" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Posyandu:</p>
              <p id="modalPosyandu" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Tanggal Skrining:</p>
              <p id="modalTgl" class="text-gray-800"></p>
            </div>
          </div>
          <div
            class="mt-6 text-left bg-blue-50 border border-blue-200 rounded-lg p-4"
          >
            <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2">
              <p class="font-semibold text-gray-700">Klasifikasi:</p>
              <p
                id="hasilKlasifikasi"
                class="text-lg font-bold text-blue-700"
              ></p>
              <p class="font-semibold text-gray-700">Tindak Lanjut:</p>
              <p
                id="hasilTindakLanjut"
                class="text-lg font-bold text-blue-700"
              ></p>
            </div>
          </div>
          <p
            id="saveStatus"
            class="text-sm text-yellow-600 font-semibold mt-4"
          ></p>
          <button
            id="okBtn"
            class="hidden bg-gradient-to-r from-blue-500 to-indigo-600 text-white font-bold py-2 px-6 rounded-xl mt-6 hover:scale-105 transition"
          >
            OK
          </button>
        </div>
      </div>
    </div>

    <!-- Confirmation Modal -->
    <div
      id="confirmModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 transition-opacity"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6 relative modal-transition"
      >
        <div class="text-center">
          <div
            class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-yellow-100 mb-4"
          >
            <i class="fas fa-exclamation-triangle text-yellow-600"></i>
          </div>
          <h3 class="text-lg font-bold text-gray-800 mb-2">Konfirmasi</h3>
          <p class="text-gray-600 mb-6">
            Data sedang disimpan. Apakah Anda yakin ingin menutup jendela ini?
          </p>
          <div class="flex space-x-4 justify-center">
            <button
              id="cancelCloseBtn"
              class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition"
            >
              Batal
            </button>
            <button
              id="confirmCloseBtn"
              class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition"
            >
              Ya, Tutup
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const GAS_WEB_APP_URL =
          "https://script.google.com/macros/s/AKfycbwlI9BTFcV3rkaVwQXKhxPAKkhp283G1kERqqDM8GgNB7al1Rw6P848mWoQjEG-xSnDVw/exec";

        const submitBtn = document.getElementById("submitBtn");
        const btnText = document.getElementById("btnText");
        const btnSpinner = document.getElementById("btnSpinner");
        const resultModal = document.getElementById("resultModal");
        const modalContent = document.getElementById("modalContent");
        const confirmModal = document.getElementById("confirmModal");
        const saveStatusEl = document.getElementById("saveStatus");
        const okBtn = document.getElementById("okBtn");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const cancelCloseBtn = document.getElementById("cancelCloseBtn");
        const confirmCloseBtn = document.getElementById("confirmCloseBtn");
        const form = document.getElementById("tbcForm");

        let isDataSaving = false;

        // SET tanggal hari ini
        document.getElementById("tanggal_skrining").value = new Date()
          .toISOString()
          .split("T")[0];

        // Fungsi untuk menampilkan notifikasi
        function showNotification(message, type) {
          const notification = document.getElementById("notification");
          notification.textContent = message;
          notification.className = `notification ${type}`;
          notification.classList.add("show");

          setTimeout(() => {
            notification.classList.remove("show");
          }, 3000);
        }

        // Fungsi validasi form
        function validateForm() {
          let isValid = true;

          // Validasi nama
          const nama = document.getElementById("nama");
          const namaError = document.getElementById("nama-error");
          if (!nama.value.trim()) {
            nama.classList.add("error-input");
            namaError.classList.remove("hidden");
            isValid = false;
          } else {
            nama.classList.remove("error-input");
            namaError.classList.add("hidden");
          }

          // Validasi NIK
          const nik = document.getElementById("nik");
          const nikError = document.getElementById("nik-error");
          if (!nik.value.trim() || !/^[0-9]{16}$/.test(nik.value)) {
            nik.classList.add("error-input");
            nikError.classList.remove("hidden");
            isValid = false;
          } else {
            nik.classList.remove("error-input");
            nikError.classList.add("hidden");
          }

          // Validasi jenis kelamin
          const jk = document.querySelector(
            'input[name="jenis_kelamin"]:checked'
          );
          const jkError = document.getElementById("jk-error");
          if (!jk) {
            jkError.classList.remove("hidden");
            isValid = false;
          } else {
            jkError.classList.add("hidden");
          }

          // Validasi tanggal lahir
          const ttl = document.getElementById("tanggal_lahir");
          const ttlError = document.getElementById("ttl-error");
          if (!ttl.value) {
            ttl.classList.add("error-input");
            ttlError.classList.remove("hidden");
            isValid = false;
          } else {
            ttl.classList.remove("error-input");
            ttlError.classList.add("hidden");
          }

          // Validasi nama orangtua
          const namaOrangtua = document.getElementById("nama_orangtua");
          const namaOrangtuaError = document.getElementById(
            "nama_orangtua-error"
          );
          if (!namaOrangtua.value.trim()) {
            namaOrangtua.classList.add("error-input");
            namaOrangtuaError.classList.remove("hidden");
            isValid = false;
          } else {
            namaOrangtua.classList.remove("error-input");
            namaOrangtuaError.classList.add("hidden");
          }

          // Validasi nomor telepon
          const nomorTelepon = document.getElementById("nomor_telepon");
          const nomorTeleponError = document.getElementById(
            "nomor_telepon-error"
          );
          if (
            !nomorTelepon.value.trim() ||
            !/^[0-9]{10,13}$/.test(nomorTelepon.value)
          ) {
            nomorTelepon.classList.add("error-input");
            nomorTeleponError.classList.remove("hidden");
            isValid = false;
          } else {
            nomorTelepon.classList.remove("error-input");
            nomorTeleponError.classList.add("hidden");
          }

          // Validasi alamat
          const alamat = document.getElementById("alamat");
          const alamatError = document.getElementById("alamat-error");
          if (!alamat.value.trim()) {
            alamat.classList.add("error-input");
            alamatError.classList.remove("hidden");
            isValid = false;
          } else {
            alamat.classList.remove("error-input");
            alamatError.classList.add("hidden");
          }

          // Validasi posyandu
          const posyandu = document.getElementById("posyandu");
          const posyanduError = document.getElementById("posyandu-error");
          if (!posyandu.value.trim()) {
            posyandu.classList.add("error-input");
            posyanduError.classList.remove("hidden");
            isValid = false;
          } else {
            posyandu.classList.remove("error-input");
            posyanduError.classList.add("hidden");
          }

          // Validasi pertanyaan A
          const qA = document.querySelector('input[name="q_a"]:checked');
          const qAError = document.getElementById("q_a-error");
          if (!qA) {
            qAError.classList.remove("hidden");
            isValid = false;
          } else {
            qAError.classList.add("hidden");
          }

          // Validasi pertanyaan B
          const qB = document.querySelector('input[name="q_b"]:checked');
          const qBError = document.getElementById("q_b-error");
          if (!qB) {
            qBError.classList.remove("hidden");
            isValid = false;
          } else {
            qBError.classList.add("hidden");
          }

          return isValid;
        }

        function urlEncodeData(obj) {
          return Object.keys(obj)
            .map(
              (k) => encodeURIComponent(k) + "=" + encodeURIComponent(obj[k])
            )
            .join("&");
        }

        function evaluateForm() {
          if (!validateForm()) {
            showNotification(
              "Mohon lengkapi semua field yang wajib diisi",
              "error"
            );
            return;
          }

          // Tampilkan loading state
          btnText.textContent = "Memproses...";
          btnSpinner.classList.remove("hidden");
          submitBtn.disabled = true;

          // Tampilkan modal dengan status loading
          okBtn.classList.add("hidden");
          saveStatusEl.textContent = "⏳ Menyimpan data, mohon tunggu...";
          resultModal.classList.remove("hidden");
          modalContent.classList.add("scale-100", "opacity-100");
          isDataSaving = true;

          const nama = document.getElementById("nama").value || "Tidak diisi";
          const nik = document.getElementById("nik").value || "Tidak diisi";
          const jkEl = document.querySelector(
            'input[name="jenis_kelamin"]:checked'
          );
          const jk = jkEl ? jkEl.value : "Tidak diisi";
          const ttl =
            document.getElementById("tanggal_lahir").value || "Tidak diisi";
          const namaOrangtua =
            document.getElementById("nama_orangtua").value || "Tidak diisi";
          const nomorTelepon =
            document.getElementById("nomor_telepon").value || "Tidak diisi";
          const alamat =
            document.getElementById("alamat").value || "Tidak diisi";
          const pos =
            document.getElementById("posyandu").value || "Tidak diisi";
          const tgl = document.getElementById("tanggal_skrining").value;

          const kontakA = document.querySelector('input[name="q_a"]:checked');
          const kontakB = document.querySelector('input[name="q_b"]:checked');
          const gejala = document.querySelectorAll(
            'input[name="gejala"]:checked'
          );

          let klasifikasi = "";
          let tindak = "";

          if (gejala.length > 0) {
            klasifikasi = "Terduga TBC";
            tindak = "Rujuk ke Puskesmas";
          } else if (
            (kontakA && kontakA.value === "ya") ||
            (kontakB && kontakB.value === "ya")
          ) {
            klasifikasi = "Kontak Erat";
            tindak = "Rujuk ke Puskesmas";
          } else {
            klasifikasi = "Bukan Terduga TBC";
            tindak = "Tidak perlu tindakan";
          }

          document.getElementById("modalNama").textContent = nama;
          document.getElementById("modalNIK").textContent = nik;
          document.getElementById("modalJk").textContent = jk;
          document.getElementById("modalTtl").textContent = ttl;
          document.getElementById("modalOrangtua").textContent = namaOrangtua;
          document.getElementById("modalTelepon").textContent = nomorTelepon;
          document.getElementById("modalAlamat").textContent = alamat;
          document.getElementById("modalPosyandu").textContent = pos;
          document.getElementById("modalTgl").textContent = tgl;
          document.getElementById("hasilKlasifikasi").textContent = klasifikasi;
          document.getElementById("hasilTindakLanjut").textContent = tindak;

          const data = {
            targetSheet: "TBCDataAnak",
            nama: nama,
            nik: nik,
            jenis_kelamin: jk,
            tanggal_lahir: ttl,
            nama_orangtua: namaOrangtua,
            nomor_telepon: nomorTelepon,
            alamat: alamat,
            posyandu: pos,
            tanggal_skrining: tgl,
            klasifikasi: klasifikasi,
            tindak_lanjut: tindak,
          };

          // Simpan data ke Google Apps Script
          fetch(GAS_WEB_APP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: urlEncodeData(data),
          })
            .then((res) => {
              if (!res.ok) {
                throw new Error("Network response was not ok");
              }
              return res.json();
            })
            .then((d) => {
              if (d.status === "success") {
                saveStatusEl.textContent = "✅ Data berhasil disimpan";
                saveStatusEl.className =
                  "text-sm text-green-600 font-semibold mt-4";
                okBtn.classList.remove("hidden");
                isDataSaving = false;
              } else {
                throw new Error("Server returned error");
              }
            })
            .catch((error) => {
              console.error("Error:", error);
              saveStatusEl.textContent = "❌ Gagal menyimpan data, coba ulangi";
              saveStatusEl.className =
                "text-sm text-red-600 font-semibold mt-4";
              isDataSaving = false;
            })
            .finally(() => {
              // Kembalikan tombol submit ke keadaan normal
              btnText.textContent = "Lihat Hasil Skrining";
              btnSpinner.classList.add("hidden");
              submitBtn.disabled = false;
            });
        }

        submitBtn.addEventListener("click", (e) => {
          e.preventDefault();
          evaluateForm();
        });

        // Event listener untuk tombol OK di modal hasil
        okBtn.addEventListener("click", () => {
          resultModal.classList.add("hidden");
          form.reset();
          showNotification("Form telah direset", "success");
        });

        // Event listener untuk tombol close di modal hasil
        closeModalBtn.addEventListener("click", () => {
          if (isDataSaving) {
            resultModal.classList.add("hidden");
            confirmModal.classList.remove("hidden");
          } else {
            resultModal.classList.add("hidden");
          }
        });

        // Event listener untuk tombol batal di modal konfirmasi
        cancelCloseBtn.addEventListener("click", () => {
          confirmModal.classList.add("hidden");
          resultModal.classList.remove("hidden");
        });

        // Event listener untuk tombol konfirmasi di modal konfirmasi
        confirmCloseBtn.addEventListener("click", () => {
          confirmModal.classList.add("hidden");
          resultModal.classList.add("hidden");
        });

        // Event listener untuk menutup modal dengan klik di luar modal
        resultModal.addEventListener("click", (e) => {
          if (e.target === resultModal && !isDataSaving) {
            resultModal.classList.add("hidden");
          } else if (e.target === resultModal && isDataSaving) {
            resultModal.classList.add("hidden");
            confirmModal.classList.remove("hidden");
          }
        });

        confirmModal.addEventListener("click", (e) => {
          if (e.target === confirmModal) {
            confirmModal.classList.add("hidden");
            resultModal.classList.remove("hidden");
          }
        });
      });
    </script>
  </body>
</html>
