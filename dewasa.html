<!DOCTYPE html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Kuesioner Skrining TBC Dewasa</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      /* Custom style untuk radio dan checkbox */
      input[type="radio"]:checked + span::before {
        background-color: #10b981;
        border-color: #10b981;
      }
      input[type="radio"]:checked + span::after {
        content: "";
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        width: 0.5rem;
        height: 0.5rem;
        background-color: white;
        border-radius: 50%;
      }
      input[type="checkbox"]:checked + span::before {
        background-color: #10b981;
        border-color: #10b981;
        background-image: url("data:image/svg+xml,%3csvg viewBox='0 0 16 16' fill='white' xmlns='http://www.w3.org/2000/svg'%3e%3cpath d='m12.207 4.793a1 1 0 0 0-1.414 0L6.5 9.086 4.707 7.293a1 1 0 0 0-1.414 1.414l2.5 2.5a1 1 0 0 0 1.414 0l5.5-5.5a1 1 0 0 0 0-1.414z'/%3e%3c/svg%3e");
        background-position: center;
        background-repeat: no-repeat;
      }
    </style>
  </head>
  <body
    class="bg-gradient-to-br from-green-50 to-emerald-100 font-sans min-h-screen p-4"
  >
    <div
      class="w-full max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl overflow-hidden"
    >
      <!-- Header -->
      <header class="bg-gradient-to-r from-green-500 to-emerald-600 p-8">
        <div
          class="flex flex-col sm:flex-row items-center justify-center gap-4"
        >
          <img
            src="https://pkmtrenggalek.github.io/SIPP/Assets/pkmtglk.jpeg"
            alt="Logo PKM Trenggalek"
            class="h-16 w-auto bg-white p-1 rounded-lg shadow-md"
          />
          <div class="text-center sm:text-left">
            <h1 class="text-3xl font-bold text-white">
              LEMBAR SKRINING TBC DEWASA
            </h1>
            <p class="text-green-100 mt-2">Posyandu & Puskesmas</p>
          </div>
        </div>
      </header>

      <form id="tbcForm" class="p-8 space-y-8">
        <!-- IDENTITAS -->
        <section class="bg-green-50 rounded-xl p-6 border border-green-200">
          <h2 class="text-2xl font-bold text-green-800 mb-6">IDENTITAS</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="md:col-span-2 lg:col-span-1">
              <label for="nama" class="block text-sm font-medium text-gray-700"
                >Nama Lengkap</label
              ><input
                type="text"
                id="nama"
                name="nama"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
              />
            </div>
            <div class="md:col-span-2 lg:col-span-1">
              <label
                for="alamat"
                class="block text-sm font-medium text-gray-700"
                >Alamat</label
              ><input
                type="text"
                id="alamat"
                name="alamat"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
              />
            </div>
            <div>
              <label for="nik" class="block text-sm font-medium text-gray-700"
                >NIK</label
              ><input
                type="text"
                id="nik"
                name="nik"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
              />
            </div>
            <div>
              <label
                for="pekerjaan"
                class="block text-sm font-medium text-gray-700"
                >Pekerjaan</label
              ><input
                type="text"
                id="pekerjaan"
                name="pekerjaan"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
              />
            </div>
            <div>
              <label
                for="tanggal_lahir"
                class="block text-sm font-medium text-gray-700"
                >Tanggal Lahir</label
              ><input
                type="date"
                id="tanggal_lahir"
                name="tanggal_lahir"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
              />
            </div>
            <div>
              <label for="usia" class="block text-sm font-medium text-gray-700"
                >Usia (Tahun)</label
              ><input
                type="text"
                id="usia"
                name="usia"
                class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg shadow-sm sm:text-sm"
                readonly
              />
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Jenis Kelamin</label
              >
              <div class="mt-2 flex space-x-4">
                <label class="flex items-center"
                  ><input
                    type="radio"
                    name="jenis_kelamin"
                    value="Laki-laki"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700"
                    >Laki-laki</span
                  ></label
                ><label class="flex items-center"
                  ><input
                    type="radio"
                    name="jenis_kelamin"
                    value="Perempuan"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700"
                    >Perempuan</span
                  ></label
                >
              </div>
            </div>
            <div>
              <label for="no_hp" class="block text-sm font-medium text-gray-700"
                >No. HP</label
              ><input
                type="tel"
                id="no_hp"
                name="no_hp"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
              />
            </div>
            <div>
              <label for="email" class="block text-sm font-medium text-gray-700"
                >Email</label
              ><input
                type="email"
                id="email"
                name="email"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
              />
            </div>
          </div>
        </section>

        <!-- PEMERIKSAAN BB, TB, DAN TEKANAN DARAH -->
        <section class="bg-blue-50 rounded-xl p-6 border border-blue-200">
          <h2 class="text-2xl font-bold text-blue-800 mb-6">
            PEMERIKSAAN BB, TB, DAN TEKANAN DARAH (DIISI OLEH PETUGAS)
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label
                for="berat_badan"
                class="block text-sm font-medium text-gray-700"
                >Berat Badan (kg)</label
              ><input
                type="number"
                id="berat_badan"
                name="berat_badan"
                step="0.1"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />
            </div>
            <div>
              <label
                for="tinggi_badan"
                class="block text-sm font-medium text-gray-700"
                >Tinggi Badan (cm)</label
              ><input
                type="number"
                id="tinggi_badan"
                name="tinggi_badan"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />
            </div>
            <div>
              <label
                for="tekanan_darah"
                class="block text-sm font-medium text-gray-700"
                >Tekanan Darah</label
              ><input
                type="text"
                id="tekanan_darah"
                name="tekanan_darah"
                placeholder="120/80"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm"
              />
            </div>
            <div>
              <label for="imt" class="block text-sm font-medium text-gray-700"
                >IMT</label
              ><input
                type="text"
                id="imt"
                name="imt"
                class="mt-1 block w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg shadow-sm sm:text-sm"
                readonly
              />
            </div>
          </div>
        </section>

        <!-- PEMERIKSAAN KONTAK -->
        <section class="bg-yellow-50 rounded-xl p-6 border border-yellow-200">
          <h2 class="text-2xl font-bold text-yellow-800 mb-6">
            PEMERIKSAAN KONTAK (DIISI OLEH PETUGAS)
          </h2>
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Riwayat Kontak TBC</label
              >
              <div class="space-y-2">
                <label class="flex items-center"
                  ><input
                    type="radio"
                    name="riwayat_kontak_tbc"
                    value="TBC"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700">TBC</span></label
                ><label class="flex items-center"
                  ><input
                    type="radio"
                    name="riwayat_kontak_tbc"
                    value="TBC RO"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700">TBC RO</span></label
                ><label class="flex items-center"
                  ><input
                    type="radio"
                    name="riwayat_kontak_tbc"
                    value="Tidak"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700">Tidak</span></label
                >
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Pernah Terdiagnosa</label
              >
              <div class="space-y-2">
                <label class="flex items-center"
                  ><input
                    type="radio"
                    name="pernah_terdiagnosa_tbc"
                    value="TBC"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700">TBC</span></label
                ><label class="flex items-center"
                  ><input
                    type="radio"
                    name="pernah_terdiagnosa_tbc"
                    value="TBC RO"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700">TBC RO</span></label
                ><label class="flex items-center"
                  ><input
                    type="radio"
                    name="pernah_terdiagnosa_tbc"
                    value="Tidak"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700">Tidak</span></label
                >
              </div>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2"
                >Pernah Berobat TBC</label
              >
              <div class="space-y-2">
                <label class="flex items-center"
                  ><input
                    type="radio"
                    name="pernah_berobat_tbc"
                    value="Ya"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700">Ya</span></label
                ><label class="flex items-center"
                  ><input
                    type="radio"
                    name="pernah_berobat_tbc"
                    value="Tidak"
                    class="peer sr-only"
                  /><span
                    class="relative w-4 h-4 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                  ></span
                  ><span class="ml-2 text-sm text-gray-700">Tidak</span></label
                >
              </div>
            </div>
            <div class="md:col-span-2 lg:col-span-3">
              <label
                for="nama_obat"
                class="block text-sm font-medium text-gray-700"
                >Jika Ya, Nama obat:</label
              ><input
                type="text"
                id="nama_obat"
                name="nama_obat"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
                disabled
              />
            </div>
          </div>
        </section>

        <!-- FORM PERTANYAAN GEJALA -->
        <section class="bg-gray-50 rounded-xl p-6 border border-gray-200">
          <h2 class="text-2xl font-bold text-gray-800 mb-6">FORM PERTANYAAN</h2>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div
              class="md:col-span-2 p-4 bg-yellow-50 border border-yellow-200 rounded-lg"
            >
              <h4 class="font-semibold text-yellow-800 mb-3">GEJALA UTAMA</h4>
              <div class="flex items-center justify-between">
                <span class="text-gray-700">Batuk lebih dari 2 minggu</span>
                <div class="flex space-x-4">
                  <label class="flex items-center cursor-pointer"
                    ><input
                      type="radio"
                      name="gejala_utama_batuk"
                      value="Ya"
                      class="peer sr-only"
                    /><span
                      class="relative w-5 h-5 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                    ></span
                    ><span class="ml-2 font-medium text-gray-700"
                      >Ya</span
                    ></label
                  ><label class="flex items-center cursor-pointer"
                    ><input
                      type="radio"
                      name="gejala_utama_batuk"
                      value="Tidak"
                      class="peer sr-only"
                    /><span
                      class="relative w-5 h-5 border-2 border-gray-400 rounded-full peer-checked:border-green-500 transition"
                    ></span
                    ><span class="ml-2 font-medium text-gray-700"
                      >Tidak</span
                    ></label
                  >
                </div>
              </div>
            </div>
            <div class="md:col-span-2">
              <h4 class="font-semibold text-gray-800 mb-3">GEJALA TAMBAHAN</h4>
            </div>
            <label
              class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
              ><span class="text-gray-700">BB turun tanpa penyebab jelas</span
              ><input
                type="checkbox"
                name="gejala_bb_turun"
                value="Ya"
                class="peer sr-only" /><span
                class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-green-500 peer-checked:bg-green-500 transition"
              ></span
            ></label>
            <label
              class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
              ><span class="text-gray-700"
                >Demam yang tidak diketahui penyebabnya</span
              ><input
                type="checkbox"
                name="gejala_demam"
                value="Ya"
                class="peer sr-only" /><span
                class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-green-500 peer-checked:bg-green-500 transition"
              ></span
            ></label>
            <label
              class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
              ><span class="text-gray-700">Badan lemas/lesu</span
              ><input
                type="checkbox"
                name="gejala_lemas"
                value="Ya"
                class="peer sr-only" /><span
                class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-green-500 peer-checked:bg-green-500 transition"
              ></span
            ></label>
            <label
              class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
              ><span class="text-gray-700"
                >Berkeringat malam hari tanpa kegiatan</span
              ><input
                type="checkbox"
                name="gejala_keringat_malam"
                value="Ya"
                class="peer sr-only" /><span
                class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-green-500 peer-checked:bg-green-500 transition"
              ></span
            ></label>
            <label
              class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
              ><span class="text-gray-700">Sesak napas tanpa nyeri dada</span
              ><input
                type="checkbox"
                name="gejala_sesak"
                value="Ya"
                class="peer sr-only" /><span
                class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-green-500 peer-checked:bg-green-500 transition"
              ></span
            ></label>
            <label
              class="flex items-center justify-between cursor-pointer p-3 rounded-lg hover:bg-white transition border border-transparent hover:border-gray-300"
              ><span class="text-gray-700"
                >Pembesaran getah bening di leher atau ketiak</span
              ><input
                type="checkbox"
                name="gejala_kelenjar"
                value="Ya"
                class="peer sr-only" /><span
                class="relative w-5 h-5 border-2 border-gray-400 rounded peer-checked:border-green-500 peer-checked:bg-green-500 transition"
              ></span
            ></label>
            <div class="md:col-span-2">
              <label
                for="gejala_lainnya"
                class="block text-sm font-medium text-gray-700"
                >Lainnya (sebutkan)</label
              ><textarea
                id="gejala_lainnya"
                name="gejala_lainnya"
                rows="3"
                class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-lg shadow-sm focus:outline-none focus:ring-green-500 focus:border-green-500 sm:text-sm"
              ></textarea>
            </div>
          </div>
        </section>
      </form>

      <!-- Tombol Submit -->
      <div class="px-8 pb-8">
        <button
          id="submitBtn"
          class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold py-4 px-8 rounded-xl shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition-all duration-300 transform hover:scale-105"
        >
          Lihat Hasil Skrining
        </button>
      </div>
    </div>

    <!-- Popup Modal Hasil -->
    <div
      id="resultModal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50 transition-opacity"
    >
      <div
        class="bg-white rounded-2xl shadow-2xl max-w-lg w-full p-8 relative transform transition-transform scale-95 opacity-0"
        id="modalContent"
      >
        <!-- Tombol Close (dinonaktifkan saat sukses) -->
        <button
          id="closeModalBtn"
          class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 transition"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M6 18L18 6M6 6l12 12"
            ></path>
          </svg>
        </button>

        <!-- Tombol OK (hanya muncul saat sukses) -->
        <button
          id="okModalBtn"
          class="hidden absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-green-500 text-white font-bold py-2 px-6 rounded-lg shadow-md hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75 transition-all duration-300"
        >
          OK
        </button>

        <div class="text-center">
          <div
            class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-green-100 mb-4"
          >
            <svg
              class="h-8 w-8 text-green-600"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"
              ></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-gray-800 mb-2">
            Hasil Skrining TBC
          </h2>
          <div class="mt-6 text-left bg-gray-50 rounded-lg p-4">
            <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2 text-sm">
              <p class="font-semibold text-gray-600">Nama:</p>
              <p id="modalNama" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Usia:</p>
              <p id="modalUsia" class="text-gray-800"></p>
              <p class="font-semibold text-gray-600">Tanggal Skrining:</p>
              <p id="modalTgl" class="text-gray-800"></p>
            </div>
          </div>
          <div
            class="mt-6 text-left bg-green-50 border border-green-200 rounded-lg p-4"
          >
            <div class="grid grid-cols-[auto_1fr] gap-x-4 gap-y-2">
              <p class="font-semibold text-gray-700">Klasifikasi:</p>
              <p
                id="hasilKlasifikasi"
                class="text-lg font-bold text-green-700"
              ></p>
              <p class="font-semibold text-gray-700">Tindak Lanjut:</p>
              <p
                id="hasilTindakLanjut"
                class="text-lg font-bold text-green-700"
              ></p>
            </div>
          </div>
          <p
            id="saveStatus"
            class="text-sm text-yellow-600 font-semibold mt-4"
          ></p>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const GAS_WEB_APP_URL =
          "https://script.google.com/macros/s/AKfycbwlI9BTFcV3rkaVwQXKhxPAKkhp283G1kERqqDM8GgNB7al1Rw6P848mWoQjEG-xSnDVw/exec";
        const form = document.getElementById("tbcForm");
        const submitBtn = document.getElementById("submitBtn");
        const resultModal = document.getElementById("resultModal");
        const modalContent = document.getElementById("modalContent");
        const closeModalBtn = document.getElementById("closeModalBtn");
        const okModalBtn = document.getElementById("okModalBtn"); // Tombol OK baru
        const saveStatusEl = document.getElementById("saveStatus");

        const today = new Date();
        const todayStr =
          today.getFullYear() +
          "-" +
          String(today.getMonth() + 1).padStart(2, "0") +
          "-" +
          String(today.getDate()).padStart(2, "0");

        // --- ELEMEN UNTUK PERHITUNGAN DAN RESET ---
        const tanggalLahirEl = document.getElementById("tanggal_lahir");
        const usiaEl = document.getElementById("usia");
        const beratBadanEl = document.getElementById("berat_badan");
        const tinggiBadanEl = document.getElementById("tinggi_badan");
        const imtEl = document.getElementById("imt");
        const namaObatEl = document.getElementById("nama_obat");
        const pernahBerobatRadios = document.querySelectorAll(
          'input[name="pernah_berobat_tbc"]'
        );

        // --- LOGIKA PERHITUNGAN OTOMATIS ---
        function hitungUsia() {
          /* ... */ if (tanggalLahirEl.value) {
            const birthDate = new Date(tanggalLahirEl.value);
            const age = Math.floor(
              (today - birthDate) / (365.25 * 24 * 60 * 60 * 1000)
            );
            usiaEl.value = !isNaN(age) && age > 0 ? age : "";
          } else {
            usiaEl.value = "";
          }
        }
        function hitungIMT() {
          /* ... */ const berat = parseFloat(beratBadanEl.value);
          const tinggi = parseFloat(tinggiBadanEl.value) / 100;
          if (!isNaN(berat) && !isNaN(tinggi) && berat > 0 && tinggi > 0) {
            const imt = (berat / (tinggi * tinggi)).toFixed(1);
            imtEl.value = imt;
          } else {
            imtEl.value = "";
          }
        }
        function toggleNamaObat() {
          /* ... */ const yaRadio = document.querySelector(
            'input[name="pernah_berobat_tbc"][value="Ya"]'
          );
          namaObatEl.disabled = !yaRadio.checked;
          if (namaObatEl.disabled) {
            namaObatEl.value = "";
          }
        }
        tanggalLahirEl.addEventListener("change", hitungUsia);
        beratBadanEl.addEventListener("input", hitungIMT);
        tinggiBadanEl.addEventListener("input", hitungIMT);
        pernahBerobatRadios.forEach((radio) =>
          radio.addEventListener("change", toggleNamaObat)
        );

        // --- LOGIKA MODAL & RESET ---
        function showModal() {
          resultModal.classList.remove("hidden");
          setTimeout(() => {
            resultModal.classList.add("opacity-100");
            modalContent.classList.remove("scale-95", "opacity-0");
            modalContent.classList.add("scale-100", "opacity-100");
          }, 10);
        }

        function hideModal() {
          resultModal.classList.remove("opacity-100");
          modalContent.classList.remove("scale-100", "opacity-100");
          modalContent.classList.add("scale-95", "opacity-0");
          setTimeout(() => {
            resultModal.classList.add("hidden");
          }, 300);
        }

        function resetFormAndModal() {
          hideModal();
          form.reset(); // Reset semua input, radio, checkbox
          // Reset field khusus yang tidak ter-reset otomatis
          usiaEl.value = "";
          imtEl.value = "";
          namaObatEl.value = "";
          namaObatEl.disabled = true;
          // Reset status modal ke kondisi awal
          saveStatusEl.textContent = "";
          okModalBtn.classList.add("hidden");
          closeModalBtn.disabled = false;
          closeModalBtn.classList.remove("opacity-50", "cursor-not-allowed");
        }

        function evaluateForm() {
          const formData = new FormData(form);
          const data = Object.fromEntries(formData.entries());
          data.tanggal_skrining = todayStr;
          data.targetSheet = "TBCDataDewasa";

          // ... (Logika klasifikasi tetap sama) ...
          const gejalaUtama = getCheckboxValue("gejala_utama_batuk") === "Ya";
          const gejalaTambahan = [
            "gejala_bb_turun",
            "gejala_demam",
            "gejala_lemas",
            "gejala_keringat_malam",
            "gejala_sesak",
            "gejala_kelenjar",
          ].some((name) => getCheckboxValue(name) === "Ya");
          const adaGejalaLainnya =
            data.gejala_lainnya && data.gejala_lainnya.trim() !== "";
          const riwayatKontak = ["TBC", "TBC RO"].includes(
            getValue("riwayat_kontak_tbc")
          );
          const pernahTerdiagnosa = ["TBC", "TBC RO"].includes(
            getValue("pernah_terdiagnosa_tbc")
          );
          const pernahBerobat = getValue("pernah_berobat_tbc") === "Ya";
          let klasifikasi = "Bukan Terduga TBC",
            tindakLanjut = "Tidak ada";
          if (gejalaUtama || adaGejalaLainnya) {
            klasifikasi = "Terduga TBC";
            tindakLanjut = "Rujuk ke Puskesmas";
          } else if (
            (riwayatKontak || pernahTerdiagnosa || pernahBerobat) &&
            (gejalaTambahan || adaGejalaLainnya)
          ) {
            klasifikasi = "Terduga TBC";
            tindakLanjut = "Rujuk ke Puskesmas";
          } else if (riwayatKontak || pernahTerdiagnosa || pernahBerobat) {
            klasifikasi = "Kontak Erat";
            tindakLanjut = "Rujuk ke Puskesmas";
          }
          data.klasifikasi = klasifikasi;
          data.tindak_lanjut = tindakLanjut;

          // Update Modal
          document.getElementById("modalNama").textContent =
            data.nama || "Tidak diisi";
          document.getElementById("modalUsia").textContent = data.usia
            ? data.usia + " Tahun"
            : "Tidak diisi";
          document.getElementById("modalTgl").textContent =
            data.tanggal_skrining;
          document.getElementById("hasilKlasifikasi").textContent = klasifikasi;
          document.getElementById("hasilTindakLanjut").textContent =
            tindakLanjut;

          // Set status modal ke kondisi "loading"
          saveStatusEl.textContent = "Menyimpan data...";
          saveStatusEl.className = "text-sm text-yellow-600 font-semibold mt-4";
          okModalBtn.classList.add("hidden");
          closeModalBtn.disabled = false; // Boleh ditutup saat loading
          closeModalBtn.classList.remove("opacity-50", "cursor-not-allowed");

          showModal(); // Tampilkan modal

          fetch(GAS_WEB_APP_URL, {
            method: "POST",
            headers: { "Content-Type": "application/x-www-form-urlencoded" },
            body: urlEncodeData(data),
          })
            .then((r) => r.json())
            .then((d) => {
              if (d.status === "success") {
                saveStatusEl.textContent = "✅ " + d.message;
                saveStatusEl.className =
                  "text-sm text-green-600 font-semibold mt-4";
                // PERUBAHAN: Tampilkan tombol OK dan nonaktifkan tombol Close
                okModalBtn.classList.remove("hidden");
                closeModalBtn.disabled = true;
                closeModalBtn.classList.add("opacity-50", "cursor-not-allowed");
              } else {
                throw new Error(d.message);
              }
            })
            .catch((e) => {
              console.error("Error:", e);
              saveStatusEl.textContent = "❌ Gagal menyimpan data.";
              saveStatusEl.className =
                "text-sm text-red-600 font-semibold mt-4";
              // Pastikan tombol OK tetap tersembunyi dan tombol Close aktif saat error
              okModalBtn.classList.add("hidden");
              closeModalBtn.disabled = false;
              closeModalBtn.classList.remove(
                "opacity-50",
                "cursor-not-allowed"
              );
            });
        }

        // Fungsi pembantu
        function urlEncodeData(obj) {
          return Object.keys(obj)
            .map(
              (key) =>
                encodeURIComponent(key) + "=" + encodeURIComponent(obj[key])
            )
            .join("&");
        }
        function getValue(name) {
          const el = document.querySelector(`input[name="${name}"]:checked`);
          return el ? el.value : "Tidak";
        }
        function getCheckboxValue(name) {
          const el = document.querySelector(`input[name="${name}"]:checked`);
          return el ? el.value : "Tidak";
        }

        // Event Listeners
        submitBtn.addEventListener("click", (e) => {
          e.preventDefault();
          evaluateForm();
        });
        okModalBtn.addEventListener("click", resetFormAndModal); // TOMBOL OK MENJALANKAN RESET
        closeModalBtn.addEventListener("click", hideModal); // TOMBOL X HANYA MENUTUP MODAL
        resultModal.addEventListener("click", (e) => {
          if (e.target === resultModal) hideModal();
        });
      });
    </script>
  </body>
</html>
